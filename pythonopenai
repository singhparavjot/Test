# Set variables
$subscriptionId = "<SubscriptionId>"
$resourceGroupName = "<ResourceGroupName>"
$openAIResourceName = "<OpenAIResourceName>"
$deploymentName = "<DeploymentName>" # Specific model deployment, e.g., 'gpt-4o'
$timespan = "2023-10-01T00:00:00Z/2023-10-02T00:00:00Z" # Adjust as needed

# Set the subscription context
Set-AzContext -SubscriptionId $subscriptionId

# Define the resource ID for the Azure OpenAI resource
$resourceId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.CognitiveServices/accounts/$openAIResourceName"

# Query the metric for Processed Inference Tokens
$metricData = Get-AzMetric -ResourceId $resourceId `
    -MetricName "ProcessedInferenceTokens" `
    -TimeGrain "PT1H" `
    -AggregationType "Total" `
    -Filter "ModelDeploymentName eq '$deploymentName'" `
    -StartTime (Get-Date).AddDays(-1) `
    -EndTime (Get-Date)

# Sum up the tokens
$totalTokens = 0
foreach ($metric in $metricData.Data) {
    $totalTokens += $metric.Total
}

# Define cost per 1,000 tokens based on your model type
$costPer1000Tokens = 0.06 # Example for GPT-4 8K context, adjust based on your model

# Calculate total cost
$cost = ($totalTokens / 1000) * $costPer1000Tokens

# Display the results
Write-Output "Deployment: $deploymentName"
Write-Output "Total Processed Tokens: $totalTokens"
Write-Output "Estimated Cost: $($cost.ToString("F4")) USD"
