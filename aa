#!/usr/bin/env python3

import argparse
import tableauserverclient as TSC

def main():
    parser = argparse.ArgumentParser(description="List Tableau workbooks by site and project.")
    parser.add_argument('--server', required=True, help='Server URL (e.g., https://my-tableau-server.com)')
    parser.add_argument('--site', required=True, help='Site name (site ID)')
    parser.add_argument('--token-value', required=True, help='Personal Access Token value')
    parser.add_argument('--token-name', required=True, help='Personal Access Token name')
    parser.add_argument('--project-name', required=False, help='Name of the Tableau project (optional)')

    args = parser.parse_args()

    # Create the authentication object
    tableau_auth = TSC.PersonalAccessTokenAuth(
        token_name=args.token_name,
        personal_access_token=args.token_value,
        site_id=args.site
    )

    # Create the server object
    server = TSC.Server(args.server, use_server_version=True)

    try:
        # Sign in to the server
        with server.auth.sign_in(tableau_auth):
            print(f"Successfully signed in as token '{args.token_name}' on site '{args.site}'")

            # If a project name was provided, find that project
            target_project = None
            if args.project_name:
                all_projects, _ = server.projects.get()
                for project in all_projects:
                    if project.name.lower() == args.project_name.lower():
                        target_project = project
                        break

                if not target_project:
                    print(f"Project '{args.project_name}' not found. Listing all workbooks in the site.")
            
            # Build request options if we have a target project
            request_opts = TSC.RequestOptions()
            if target_project:
                request_opts.filter.add(
                    TSC.Filter(
                        field=TSC.RequestOptions.Field.ProjectId,
                        operator=TSC.RequestOptions.Operator.Equals,
                        value=target_project.id
                    )
                )

            # Get the list of workbooks (either for the project or entire site)
            all_workbooks, pagination_item = server.workbooks.get(request_opts)

            # Print out the name of each workbook
            print(f"\nFound {pagination_item.total_available} workbooks.")
            for wb in all_workbooks:
                print(f"- {wb.name} (ID: {wb.id})")

    except TSC.ServerResponseError as e:
        print(f"Error communicating with Tableau Server: {e}")

if __name__ == '__main__':
    main()
