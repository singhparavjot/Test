# Connect to Azure account
Connect-AzAccount

# Set your subscription ID
$SubscriptionId = "your-subscription-id"  # Replace with your actual subscription ID
Select-AzSubscription -SubscriptionId $SubscriptionId

# Set the start and end dates for September 2024
$StartDate = "2024-09-01"
$EndDate = "2024-09-30"

# Get consumption usage details for the specified time period
$UsageDetails = Get-AzConsumptionUsageDetail -StartDate $StartDate -EndDate $EndDate

# Filter for Azure Databricks services
$DatabricksUsage = $UsageDetails | Where-Object { $_.Product -like "*Databricks*" }

# Extract node type/worker type from MeterName or MeterSubCategory
$DatabricksUsageWithNodeType = $DatabricksUsage | Select-Object `
    @{Name="Date";Expression={$_.Date}},
    @{Name="ResourceGroup";Expression={$_.ResourceGroupName}},
    @{Name="ResourceId";Expression={$_.InstanceId}},
    @{Name="Product";Expression={$_.Product}},
    @{Name="MeterCategory";Expression={$_.MeterCategory}},
    @{Name="MeterSubCategory";Expression={$_.MeterSubCategory}},
    @{Name="MeterName";Expression={$_.MeterName}},
    @{Name="ConsumedQuantity";Expression={$_.ConsumedQuantity}},
    @{Name="Cost";Expression={$_.Cost}},
    @{Name="Currency";Expression={$_.Currency}},
    @{Name="NodeType";Expression={
        # Try to extract node type from MeterName or MeterSubCategory
        if ($_.MeterName -match "Standard_[A-Za-z0-9_]+") {
            $Matches[0]
        } elseif ($_.MeterSubCategory -match "Standard_[A-Za-z0-9_]+") {
            $Matches[0]
        } else {
            "Unknown"
        }
    }}

# Export the data to a CSV file
$DatabricksUsageWithNodeType | Export-Csv -Path "DatabricksCost_Sep2024.csv" -NoTypeInformation

Write-Host "CSV file 'DatabricksCost_Sep2024.csv' has been created successfully."
