 
import os
from flask import Flask, jsonify
import pyodbc, struct
from azure.identity import DefaultAzureCredential

app = Flask(__name__)
connection_string = "Driver={ODBC Driver 18 for SQL Server};Server=tcp:testdemoapp.database.windows.net,1433;Database=testdemo;Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30"
def get_all():
    with get_conn() as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM Persons")
    return
def get_conn():
    credential = DefaultAzureCredential(exclude_interactive_browser_credential=False)
    token_bytes = credential.get_token("https://database.windows.net/.default").token.encode("UTF-16-LE")
    token_struct = struct.pack(f'<I{len(token_bytes)}s', len(token_bytes), token_bytes)
    SQL_COPT_SS_ACCESS_TOKEN = 1256  
    conn = pyodbc.connect(connection_string, attrs_before={SQL_COPT_SS_ACCESS_TOKEN: token_struct})
    return conn

@app.route('/')  
def index():
    data = []
    with get_conn() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM testtable") 
            results = [dict(zip([column[0] for column in cursor.description], row)) for row in cursor.fetchall()]
            return jsonify(results)

if __name__ == '__main__':
    app.run(debug=True)
 
